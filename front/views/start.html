<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio del Juego</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Inicio del Juego</h1>
    <div id="gameInfo"></div>

    <button id="readyButton" onclick="markPlayerReady()">Estoy listo</button>
    <p id="gameStatus"></p>

    <script src="/socket.io/socket.io.js"></script> <!-- Asegúrate de tener socket.io cargado -->
    <script>
        let playerReady = false;
        let opponentReady = false;

        // Cargar la información del juego desde el localStorage
        const gameInfo = JSON.parse(localStorage.getItem('gameInfo'));
        const socket = io(); // Conectar al servidor de WebSocket

        function loadGameInfo() {
            const gameInfoDiv = document.getElementById('gameInfo');

            if (!gameInfo) {
                gameInfoDiv.textContent = 'No se encontró información de la partida. Regresa a la página anterior.';
                return;
            }

            // Mostrar la información de la partida en la página
            gameInfoDiv.innerHTML = 
                `<p><strong>ID de la Sala:</strong> ${gameInfo.gameId}</p>
                <p><strong>Jugador 1:</strong> ${gameInfo.player1}</p>
                <p><strong>Jugador 2:</strong> ${gameInfo.player2 || 'Esperando al Jugador 2'}</p>
                <p><strong>Monto a apostar:</strong> ${gameInfo.betAmount} ${gameInfo.tokenType}</p>
                <p><strong>Blockchain:</strong> ${gameInfo.blockchain}</p>
                <p><strong>Estado de la partida:</strong> ${gameInfo.gameStatus}</p>`;

            // Emitir evento de unirse a la sala
            socket.emit('joinRoom', gameInfo.gameId, gameInfo.player1);
        }

        // El jugador indica que está listo
        function markPlayerReady() {
            playerReady = true;
            document.getElementById('gameStatus').textContent = 'Esperando al segundo jugador...';

            // Emitir evento indicando que el jugador está listo
            socket.emit('ready', gameInfo.gameId);
        }

        // Escuchar evento de que el segundo jugador se ha unido a la sala
        socket.on('playerJoined', (data) => {
            gameInfo.player2 = data.playerName;
            localStorage.setItem('gameInfo', JSON.stringify(gameInfo));

            // Actualizar la información del jugador 2 en la pantalla
            document.getElementById('gameInfo').innerHTML += `<p><strong>Jugador 2:</strong> ${data.playerName}</p>`;
        });

        // Escuchar evento de que el oponente está listo
        socket.on('opponentReady', () => {
            opponentReady = true;
            checkIfBothPlayersReady();
        });

        // Verificar si ambos jugadores están listos para iniciar el juego
        function checkIfBothPlayersReady() {
            if (playerReady && opponentReady) {
                gameInfo.gameStatus = 'En progreso';
                localStorage.setItem('gameInfo', JSON.stringify(gameInfo));
                
                alert('Ambos jugadores están listos. Redirigiendo al tablero...');
                window.location.href = 'chessboard.html'; // Redirigir a la página del tablero
            }
        }

        // Cargar la información del juego al cargar la página
        loadGameInfo();
    </script>
</body>
</html>
